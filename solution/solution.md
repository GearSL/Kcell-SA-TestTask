# ОГЛАВЛЕНИЕ
- [ОГЛАВЛЕНИЕ](#оглавление)
- [Команда](#команда)
  - [Структура команды](#структура-команды)
  - [Функциональные обязанности команды](#функциональные-обязанности-команды)
    - [Product owner:](#product-owner)
    - [System analyst:](#system-analyst)
    - [Team / Tech Lead:](#team--tech-lead)
    - [Android / IOS разработчик / Backend разработчик:](#android--ios-разработчик--backend-разработчик)
    - [DevOps:](#devops)
    - [Тестировщик:](#тестировщик)
- [Бизнес процесс](#бизнес-процесс)
  - [Схема:](#схема)
  - [Описание бизнес процесса:](#описание-бизнес-процесса)
- [План разработки](#план-разработки)
- [Сущности](#сущности)
- [Архитектура](#архитектура)
  - [Технологический стек](#технологический-стек)
  - [Логика работы](#логика-работы)
    - [Активация оплаты с баланса](#активация-оплаты-с-баланса)
  - [Диаграмма классов](#диаграмма-классов)
- [Инфраструктура](#инфраструктура)
  - [Архитектурная схема](#архитектурная-схема)
- [Контроль работы и проверка качества](#контроль-работы-и-проверка-качества)

> ps.: с продуктом от **DiDi** ознакомиться к сожалению не удалось т.к. у них не работает регистрация поэтому делал ориентируясь на **Yandex Go**.

# Команда
- Product owner;
- System analyst;
- Backend Team Lead;
- Mobile Team Lead;
- Developers: 
   - Android / IOS developers;
   - Backend developers;
- DevOps;
- QA Engineer;
- Designer - не обязательно, возможен аутсорс / аутстаф / фриланс но если есть бюджет или человек без дела в смежной команде то считаем что будет отлично;

## Структура команды
![org_structure.drawio](./assets/org_structure.drawio.png)

## Функциональные обязанности команды
### Product owner:
1. Определение потребностей пользователя;
2. Определение требований при постановке задач;
3. Написание Epic задач;
4. Стратегическое планирование;
5. Согласование и планирование продуктового бэклога;
6. Приоритезация продуктового бэклога;
7. Контроль за выполнением поставленных задач;
8. Взаимодействие с командой и системным аналитиком;

### System analyst:
1. Сбор требований;
2. Описание бизнес процессов;
3. Разработка схем и диаграм необходимых для описания процессов и требований;
4. Декомпозиция Epic задач;
5. Написание user story;
6. Написание технических заданий;
7. Написание пользовательских сценариев;
8. Согласование ченжлога и релиза;

### Team / Tech Lead:
1. Проведение ивентов команды;
2. Помощь команде в решении поставленных задач;
3. Код ревью;
4. Выполнение поставленных задач в т.ч. написание кода;
5. Приемка задач на спринт; 
6. Формирование спринт бэклога;
7. Сбор ченжлога;
8. Публикация релиза;

### Android / IOS разработчик / Backend разработчик:
1. Выполнение поставленных задач;
2. Участие в ивентах команды;
3. Код ревью (при наличии кросс ревью или необходимости замены Тим / Тех лида);
4. Написание юнит тестов;

### DevOps:
1. Подготовка окружения (test / staging / production);
2. CI / CD;
3. Взаимодействие с инфраструктурными вендорами;
4. Взаимодействие с другими командами;

### Тестировщик:
1. Написание тест кейсов;
2. Ручное тестирование;
3. Написание автотестов;
4. Создание задач на исправление найденных ошибок (hotfix);

# Бизнес процесс
## Схема:
Предполагаемый бизнес процесс описан в BPMN2 схеме исходник которой можно [просмотреть на cawemo](https://cawemo.com/share/e9cbdaee-ce33-4ca5-8716-868d2e31c2e2). Схема бизнес процесса выглядит следующим образом:
![](assets/yandex-go-balance-payment-scheme.svg)
следует учитывать что картинка бизнес процесса может не отражать последних изменений и размещена тут исключительно ради примера и на тот случай если по какой то причине не получится получить доступ к исходнику на cawemo.com.

> ps.: Сервис нотификаций не отрисовываю т.к. время ограничено и вроде как нет необходимости т.к. и без него должно быть понятно.

## Описание бизнес процесса:
1. Пользователь открывает мобильное приложение Yandex Go и вводит или выбирает место отправления и место назначения;
2. Приложение через обращение к сервису поездок вычисляет стоимость поездки и предлагает пользователю различные тарифы;
3. Пользователь выбирает тариф и осуществляет заказ;
4. Пользователь решает оплатить проезд с помощью мобильного баланса;
   - Если у пользователя уже имеется добавленный способ оплаты тогда идем дальше;
   - Если у пользователя нет добавленного метода оплаты он проходит процедуру добавления данного метода;
5. Пользователь выбирает метод оплаты с мобильного баланса и подтверждает операцию;
6. После завершения поездки водитель подтверждает ее завершение;
7. Приложение связывается с МФС для обработки платежа;
8. МФС передает информацию об успешной транзакции в приложение;
9. Приложение подтверждает успешный платеж и поездка завершается;

# План разработки
1. Добавить в мобильные приложения функциональность для выбора способа оплаты с баланса клиента. Данный пункт включает доработки по фронту мобильного приложения + интеграцию с сервисом оплаты;
2. Разработать сервис оплаты с баланса клиента;

# Сущности
![erd.svg](./assets/erd.svg)
> Диаграмма с описанием сущностей немного потеряла актуальность, обновить после завершения ТЗ.

# Архитектура
## Технологический стек
- Java 20;
- Spring Boot 3.1.3;
- PostgreSQL 15;

## Логика работы
### Активация оплаты с баланса
1. Клиентский сервис отправляет `HTTP POST` запрос на `https://{base-url}/login` в котором передается логин и пароль партнера для получения `Bearer` токена:
   ```json
   {
      "userName": "merchantName",
      "password": "password"
   }
   ```
   тело запроса должно мапиться на `JwtRequestDTO`. При успешном запросе в ответе ожидается токен:
   ```json
   {
      "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJpbHlhc0Bnb29nbGUuY29tIiwicm9sZXMiOlsiUk9MRV9VU0VSIl0sImV4cCI6MTY5NDg4NjE3NSwiaWF0IjoxNjk0ODg0Mzc1fQ.NwfArrUD2BDatiP8FbfhJYF1INqZXE4NHk2trK7PhzM"
   }
   ```
   Запрос может вернуть следующие коды:
   - 200 - при успешной авторизации;
   - 401 - во всех остальных случаях;
   - 422 - ошибка валидации;

    Полученный токен используется для авторизации на закрытых эндпоинтах и передается в заголовке `Authorization`.
2. Клиентский сервис отправляет `HTTP POST` на `https://{base-url}/activation/code` запрос для активации платежей с мобильного баланса. В теле запроса должен передаваться номер клиента:
   ```json
   {
      "phoneNumber": "+77078887755"
   }
   ```
   Тело запроса должно мапиться на `UserDTO`. При успешном запросе в ответ ожидается:
   ```json
   {
      "codeId": 111,
      "createdAt": 1694884636.776604000
   }
   ```
   Запрос может вернуть следующие коды:
   - 200 - успех;
   - 400 - активация оплаты для данного клиента в рамках авторизованного клиента уже выполнена и пр. ошибки (!!!обсудить с командой разработки, возможно стоит согласовать как разложить на кастомные коды ошибок);
   - 403 - необходима авторизация;
   - 404 - пользователь не найден;
   - 422 - ошибка валидации;
  
   Отправка уведомления клиенту (`User`) осуществляется с использованием нашего сервиса нотификаций сообщение в который отправляется в `NotificationService`, в качестве транспорта используется `RabbitMQ`.

3. Для завершения активации платежей клиентскому сервису необходимо переслать посредством `HTTP POST` запроса введенный клиентом код активации на `https://{base-url}/activation/confirm`:
   ```json
   {
      "phoneNumber": "+77078887755",
      "code": "4455"
   }
   ```
   тело запроса должно мапиться на `CodeConfirmDTO`. При успешном запросе в ответ ожидается:
   ```json
   {
    // подумать и согласовать с командой разработчиков, возможно стоит возвращать информацию которая пригодится мерчанту в будущем
      "codeId": 111,
      "createdAt": 1694884636.776604000
   }
   ```
   Запрос может вернуть следующие коды ответа:
   - 200 - код успешно подтвержден;
   - 400 - не верный код подтверждения;
   - 403 - необходима авторизация;
   - 404 - код не найден;
   - 422 - ошибка валидации;
4. После успешной активации клиентскому сервису доступны оплаты `https://{base-url}/payments` ...
   > Тут должно появиться описание ... To be continued ...
## Диаграмма классов
![Uml class diagramm](assets/UmlclassDiagram.drawio.svg)
![Alt text](./assets/uml_class_diagram_meme.jpg)


# Инфраструктура
- Мобильное приложение Yandex Go на платформах Android и iOS;
- Сервер под MFS сервис;
- Сервер под базу данных сервиса;
- Система мониторинга и логирования для обеспечения безопасности и отслеживания ошибок;
## Архитектурная схема
![Architectural diagram](./assets/architectural_diagram.drawio.svg)
  
# Контроль работы и проверка качества
- Выбор методологии разработки (например, Agile);
- Разработка плана проекта с распределением задач по срокам и ролям;
- Ежедневные стендап-встречи для контроля выполнения задач;
- Учет затраченного времени по задачам и выход членов команды на норму часов;
- Контроль качества кода и тестирование в каждом этапе разработки;
- Финальное тестирование перед запуском проекта;
